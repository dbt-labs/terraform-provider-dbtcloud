name: Semantic Layer Issue #516 Reproduction

on:
  workflow_dispatch:
    inputs:
      account_id:
        description: 'dbt Cloud Account ID where the environment exists'
        required: true
        type: string
      token:
        description: 'dbt Cloud API Token (service token or personal access token with access to the account)'
        required: true
        type: string
      host_url:
        description: 'dbt Cloud Host URL (e.g., https://cloud.getdbt.com/api or https://YOUR_ACCOUNT.us1.dbt.com/api)'
        required: true
        type: string
      project_id:
        description: 'Pre-existing dbt Cloud Project ID (should contain the environment)'
        required: true
        type: string
      environment_id:
        description: 'Pre-existing dbt Cloud Environment ID (must have successful job runs)'
        required: true
        type: string
      run_second_apply:
        description: 'Run second terraform apply to reproduce the issue'
        required: false
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  reproduce-semantic-layer-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@19bb51245e9c80abacb2e91cc42b33fa478b8639 # actions/setup-go@v4
        with:
          go-version: '>=1.17.0'

      - name: Build and install provider
        run: make install

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # hashicorp/setup-terraform@v3

      - name: Prepare test directory
        run: |
          # Create a clean directory for semantic layer tests
          mkdir -p semantic_layer_issue_516
        working-directory: ./testing/cicd

      - name: Create test configuration for semantic layer
        run: |
          cat > terraform.tf << 'EOF'
          terraform {
            required_providers {
              dbtcloud = {
                source  = "dbt-labs/dbtcloud"
                version = ">= 1.2.0"
              }
            }
          }

          provider "dbtcloud" {
            account_id = var.dbt_cloud_account_id
            token      = var.dbt_cloud_token
            host_url   = var.dbt_cloud_host_url
          }
          EOF

          cat > variables.tf << 'EOF'
          variable "dbt_cloud_account_id" {
            description = "dbt Cloud Account ID"
            type        = number
          }

          variable "dbt_cloud_token" {
            description = "dbt Cloud Token"
            type        = string
            sensitive   = true
          }

          variable "dbt_cloud_host_url" {
            description = "dbt Cloud Host URL"
            type        = string
            default     = "https://cloud.getdbt.com/api"
          }

          variable "project_id" {
            description = "Pre-existing Project ID"
            type        = number
          }

          variable "environment_id" {
            description = "Pre-existing Environment ID (must have successful job runs)"
            type        = number
          }

          variable "bigquery_private_key_id" {
            description = "BigQuery Private Key ID"
            type        = string
            sensitive   = true
          }

          variable "bigquery_private_key" {
            description = "BigQuery Private Key"
            type        = string
            sensitive   = true
          }

          variable "bigquery_client_email" {
            description = "BigQuery Client Email"
            type        = string
            sensitive   = true
          }

          variable "bigquery_client_id" {
            description = "BigQuery Client ID"
            type        = string
            sensitive   = true
          }

          variable "bigquery_client_x509_cert_url" {
            description = "BigQuery Client x509 Cert URL"
            type        = string
            sensitive   = true
          }
          EOF

          cat > locals.tf << 'EOF'
          # Locals to simulate the user's configuration pattern from Issue #516
          locals {
            # Simulated project configuration using pre-existing project_id
            projects_config = {
              "analytical_layer" = {
                project_id = var.project_id  # Use pre-existing project
                semantic_layer = {
                  environment_id = var.environment_id  # Use pre-existing environment
                  credentials = [
                    {
                      name            = "semantic layer analytical layer"
                      service_account = "test"
                      is_active       = true
                      num_threads     = 4
                      dataset         = "test_dataset"
                      service_tokens  = []  # Will be populated with service token IDs
                    }
                  ]
                }
              }
            }

            semantic_layer_projects = {
              for k, v in local.projects_config : k => v if try(v.semantic_layer, null) != null
            }

            semantic_layer_credentials = flatten([
              for k, v in local.semantic_layer_projects : [
                for credential in v.semantic_layer.credentials : [
                  merge(
                    credential,
                    { "project_key" : k }
                  )
                ]
              ]
            ])

            semantic_layer_credentials_unique_keys = {
              for credential in local.semantic_layer_credentials :
              "${credential.project_key}-${credential.name}" => credential
            }

            semantic_layer_service_tokens = flatten([
              for credential_key, credential in local.semantic_layer_credentials_unique_keys : [
                for token in credential.service_tokens : {
                  project_name       = credential.project_key,
                  credential_key     = credential_key,
                  service_token_id   = token
                }
              ]
            ])

            semantic_layer_service_tokens_unique_keys = {
              for token in local.semantic_layer_service_tokens :
              "${token.credential_key}-${token.service_token_id}" => token
            }
          }
          EOF

          cat > semantic_layer.tf << 'EOF'
          # Using pre-existing project_id and environment_id
          # No project creation needed - using existing project

          # Create semantic layer configurations (using for_each like in Issue #516)
          # Using pre-existing project_id and environment_id that has successful job runs
          resource "dbtcloud_semantic_layer_configuration" "semantic_layer" {
            for_each       = local.semantic_layer_projects
            project_id     = each.value.project_id
            environment_id = each.value.semantic_layer.environment_id
          }

          # Create BigQuery semantic layer credentials (using for_each like in Issue #516)
          resource "dbtcloud_bigquery_semantic_layer_credential" "semantic_layer" {
            for_each = local.semantic_layer_credentials_unique_keys
            
            configuration = {
              project_id      = local.projects_config[each.value.project_key].project_id
              name            = each.value.name
              adapter_version = "bigquery_v0"
            }
            
            credential = {
              project_id  = local.projects_config[each.value.project_key].project_id
              is_active   = each.value.is_active
              num_threads = each.value.num_threads
              dataset     = each.value.dataset
            }
            
            private_key_id              = var.bigquery_private_key_id
            private_key                 = var.bigquery_private_key
            client_email                = var.bigquery_client_email
            client_id                   = var.bigquery_client_id
            auth_uri                    = "https://accounts.google.com/o/oauth2/auth"
            token_uri                   = "https://oauth2.googleapis.com/token"
            auth_provider_x509_cert_url = "https://www.googleapis.com/oauth2/v1/certs"
            client_x509_cert_url        = var.bigquery_client_x509_cert_url
            
            depends_on = [dbtcloud_semantic_layer_configuration.semantic_layer]
          }

          # Note: Skipping service token mapping since we don't have service tokens in the simplified version
          # The issue reproduces with just the semantic_layer_configuration and credential resources
          EOF

          cat > outputs.tf << 'EOF'
          # Outputs to verify resource creation
          output "semantic_layer_config_ids" {
            description = "Map of semantic layer configuration IDs"
            value       = { for k, v in dbtcloud_semantic_layer_configuration.semantic_layer : k => v.id }
          }

          output "semantic_layer_credential_ids" {
            description = "Map of semantic layer credential IDs"
            value       = { for k, v in dbtcloud_bigquery_semantic_layer_credential.semantic_layer : k => v.id }
          }

          output "project_id_used" {
            description = "The project ID used for testing"
            value       = var.project_id
          }

          output "environment_id_used" {
            description = "The environment ID used for testing"
            value       = var.environment_id
          }
          EOF
        working-directory: ./testing/cicd/semantic_layer_issue_516

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ./testing/cicd/semantic_layer_issue_516

      - name: Debug - Show Local Values
        run: |
          echo "=== Debugging Local Values ==="
          echo "Showing projects_config:"
          terraform console <<EOF
          local.projects_config
          EOF
          
          echo ""
          echo "Showing semantic_layer_projects:"
          terraform console <<EOF
          local.semantic_layer_projects
          EOF
          
          echo ""
          echo "Showing semantic_layer_credentials:"
          terraform console <<EOF
          local.semantic_layer_credentials
          EOF
          
          echo ""
          echo "Showing semantic_layer_credentials_unique_keys:"
          terraform console <<EOF
          local.semantic_layer_credentials_unique_keys
          EOF
        working-directory: ./testing/cicd/semantic_layer_issue_516
        env:
          TF_VAR_dbt_cloud_account_id: ${{ github.event.inputs.account_id }}
          TF_VAR_dbt_cloud_token: ${{ github.event.inputs.token }}
          TF_VAR_dbt_cloud_host_url: ${{ github.event.inputs.host_url }}
          TF_VAR_project_id: ${{ github.event.inputs.project_id }}
          TF_VAR_environment_id: ${{ github.event.inputs.environment_id }}
          TF_VAR_bigquery_private_key_id: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY_ID }}
          TF_VAR_bigquery_private_key: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY }}
          TF_VAR_bigquery_client_email: ${{ secrets.TEST_BIGQUERY_CLIENT_EMAIL }}
          TF_VAR_bigquery_client_id: ${{ secrets.TEST_BIGQUERY_CLIENT_ID }}
          TF_VAR_bigquery_client_x509_cert_url: ${{ secrets.TEST_BIGQUERY_CLIENT_X509_CERT_URL }}

      - name: Terraform Plan (First Run)
        id: plan_first
        run: terraform plan -out=tfplan_first
        working-directory: ./testing/cicd/semantic_layer_issue_516
        env:
          TF_VAR_dbt_cloud_account_id: ${{ github.event.inputs.account_id }}
          TF_VAR_dbt_cloud_token: ${{ github.event.inputs.token }}
          TF_VAR_dbt_cloud_host_url: ${{ github.event.inputs.host_url }}
          TF_VAR_project_id: ${{ github.event.inputs.project_id }}
          TF_VAR_environment_id: ${{ github.event.inputs.environment_id }}
          TF_VAR_bigquery_private_key_id: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY_ID }}
          TF_VAR_bigquery_private_key: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY }}
          TF_VAR_bigquery_client_email: ${{ secrets.TEST_BIGQUERY_CLIENT_EMAIL }}
          TF_VAR_bigquery_client_id: ${{ secrets.TEST_BIGQUERY_CLIENT_ID }}
          TF_VAR_bigquery_client_x509_cert_url: ${{ secrets.TEST_BIGQUERY_CLIENT_X509_CERT_URL }}

      - name: Terraform Apply (First Run - Should Succeed)
        id: apply_first
        run: |
          echo "=== FIRST TERRAFORM APPLY ==="
          terraform apply tfplan_first
          echo "=== FIRST APPLY COMPLETED ==="
        working-directory: ./testing/cicd/semantic_layer_issue_516
        env:
          TF_VAR_dbt_cloud_account_id: ${{ github.event.inputs.account_id }}
          TF_VAR_dbt_cloud_token: ${{ github.event.inputs.token }}
          TF_VAR_dbt_cloud_host_url: ${{ github.event.inputs.host_url }}
          TF_VAR_project_id: ${{ github.event.inputs.project_id }}
          TF_VAR_environment_id: ${{ github.event.inputs.environment_id }}
          TF_VAR_bigquery_private_key_id: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY_ID }}
          TF_VAR_bigquery_private_key: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY }}
          TF_VAR_bigquery_client_email: ${{ secrets.TEST_BIGQUERY_CLIENT_EMAIL }}
          TF_VAR_bigquery_client_id: ${{ secrets.TEST_BIGQUERY_CLIENT_ID }}
          TF_VAR_bigquery_client_x509_cert_url: ${{ secrets.TEST_BIGQUERY_CLIENT_X509_CERT_URL }}

      - name: Show State After First Apply
        run: terraform show
        working-directory: ./testing/cicd/semantic_layer_issue_516

      - name: Terraform Plan (Second Run - Check for drift)
        id: plan_second
        if: ${{ github.event.inputs.run_second_apply == 'true' || github.event.inputs.run_second_apply == '' }}
        run: |
          echo "=== SECOND TERRAFORM PLAN (Checking for drift) ==="
          terraform plan -out=tfplan_second
          echo "=== SECOND PLAN COMPLETED ==="
        working-directory: ./testing/cicd/semantic_layer_issue_516
        continue-on-error: true
        env:
          TF_VAR_dbt_cloud_account_id: ${{ github.event.inputs.account_id }}
          TF_VAR_dbt_cloud_token: ${{ github.event.inputs.token }}
          TF_VAR_dbt_cloud_host_url: ${{ github.event.inputs.host_url }}
          TF_VAR_project_id: ${{ github.event.inputs.project_id }}
          TF_VAR_environment_id: ${{ github.event.inputs.environment_id }}
          TF_VAR_bigquery_private_key_id: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY_ID }}
          TF_VAR_bigquery_private_key: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY }}
          TF_VAR_bigquery_client_email: ${{ secrets.TEST_BIGQUERY_CLIENT_EMAIL }}
          TF_VAR_bigquery_client_id: ${{ secrets.TEST_BIGQUERY_CLIENT_ID }}
          TF_VAR_bigquery_client_x509_cert_url: ${{ secrets.TEST_BIGQUERY_CLIENT_X509_CERT_URL }}

      - name: Terraform Apply (Second Run - Should Reproduce Issue #516)
        id: apply_second
        if: ${{ github.event.inputs.run_second_apply == 'true' || github.event.inputs.run_second_apply == '' }}
        run: |
          echo "=== SECOND TERRAFORM APPLY (Expected to reproduce Issue #516) ==="
          terraform apply -auto-approve
          echo "=== SECOND APPLY COMPLETED ==="
        working-directory: ./testing/cicd/semantic_layer_issue_516
        continue-on-error: true
        env:
          TF_VAR_dbt_cloud_account_id: ${{ github.event.inputs.account_id }}
          TF_VAR_dbt_cloud_token: ${{ github.event.inputs.token }}
          TF_VAR_dbt_cloud_host_url: ${{ github.event.inputs.host_url }}
          TF_VAR_project_id: ${{ github.event.inputs.project_id }}
          TF_VAR_environment_id: ${{ github.event.inputs.environment_id }}
          TF_VAR_bigquery_private_key_id: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY_ID }}
          TF_VAR_bigquery_private_key: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY }}
          TF_VAR_bigquery_client_email: ${{ secrets.TEST_BIGQUERY_CLIENT_EMAIL }}
          TF_VAR_bigquery_client_id: ${{ secrets.TEST_BIGQUERY_CLIENT_ID }}
          TF_VAR_bigquery_client_x509_cert_url: ${{ secrets.TEST_BIGQUERY_CLIENT_X509_CERT_URL }}

      - name: Check Second Apply Result
        if: ${{ github.event.inputs.run_second_apply == 'true' || github.event.inputs.run_second_apply == '' }}
        run: |
          if [ "${{ steps.apply_second.outcome }}" == "failure" ]; then
            echo "::warning::Second terraform apply failed - Issue #516 reproduced!"
            echo "This is the expected behavior demonstrating the bug."
          else
            echo "::notice::Second terraform apply succeeded - Issue #516 NOT reproduced"
            echo "This might indicate the issue has been fixed or environmental differences."
          fi

      - name: Show State After Second Apply
        if: always()
        run: terraform show
        working-directory: ./testing/cicd/semantic_layer_issue_516

      - name: Terraform Destroy
        if: always() # This step will always run to clean up resources
        run: |
          echo "=== CLEANING UP RESOURCES ==="
          terraform destroy -auto-approve
          echo "=== CLEANUP COMPLETED ==="
        working-directory: ./testing/cicd/semantic_layer_issue_516
        env:
          TF_VAR_dbt_cloud_account_id: ${{ github.event.inputs.account_id }}
          TF_VAR_dbt_cloud_token: ${{ github.event.inputs.token }}
          TF_VAR_dbt_cloud_host_url: ${{ github.event.inputs.host_url }}
          TF_VAR_project_id: ${{ github.event.inputs.project_id }}
          TF_VAR_environment_id: ${{ github.event.inputs.environment_id }}
          TF_VAR_bigquery_private_key_id: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY_ID }}
          TF_VAR_bigquery_private_key: ${{ secrets.TEST_BIGQUERY_PRIVATE_KEY }}
          TF_VAR_bigquery_client_email: ${{ secrets.TEST_BIGQUERY_CLIENT_EMAIL }}
          TF_VAR_bigquery_client_id: ${{ secrets.TEST_BIGQUERY_CLIENT_ID }}
          TF_VAR_bigquery_client_x509_cert_url: ${{ secrets.TEST_BIGQUERY_CLIENT_X509_CERT_URL }}

      - name: Upload Terraform Logs
        if: always()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # actions/upload-artifact@v4
        with:
          name: terraform-logs
          path: |
            ./testing/cicd/semantic_layer_issue_516/.terraform/
            ./testing/cicd/semantic_layer_issue_516/terraform.tfstate
            ./testing/cicd/semantic_layer_issue_516/terraform.tfstate.backup
            ./testing/cicd/semantic_layer_issue_516/*.tfplan
            ./testing/cicd/semantic_layer_issue_516/*.tf
          retention-days: 7

